---
title: "Assignment: Temporal Diversity"
author: "RZ Moger-Reischer; Z620: Quantitative Biodiversity, Indiana University"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
geometry: margin=2.54cm
---

## OVERVIEW

In this Assignment, we extend our understanding of diversity from the spatial dimension to the temporal dimension. 

After completing this exercise you will know how to:

1. wrangle a large dataset to visualize and analyze time series data
2. test hypotheses from experiments with temporal data
3. quantify temporal $\beta$-diversity and stability

## Directions:
1. Change "Student Name" on line 3 (above) with your name.
2. Complete as much of the exercise as possible during class; what you do not complete in class will need to be done on your own outside of class.
3. Use the Handout as a guide; it contains a more complete description of data sets along with the proper scripting needed to carry out the exercise.
4. Be sure to **answer the questions** in this exercise document; they also correspond to the Handout.
Space for your answer is provided in this document and indicated by the ">" character.
If you need a second paragraph be sure to start the first line with ">".
5. Before you leave the classroom, **push** this file to your GitHub repo.
6. When you are done with the Assignment, **Knit** the text and code into a html file.
7. After Knitting, please submit the completed Assignment by creating a **pull request** via GitHub.
Your pull request should include this file *temporal_assignment.Rmd* and the html output of `Knitr` (*temporal_assignment.html*).

## 1) R SETUP

Typically, the first thing you will do in either an R script or an RMarkdown file is setup your environment. 
This includes things such as setting the working directory and loading any packages that you will need.

In the R code chunk below, provide the code to:  

1. clear your R environment,
2. print your current working directory,
3. set your working directory to your "*/Week5-Temporal*" folder, and 
4. load any packages you need to complete the assignment.

```{r}
#rm(list=ls())
getwd()
#setwd("~/GitHub/QB-2017/Week5-Temporal/")
package.list <- c('vegan', 'tidyr', 'dplyr', 'codyn', 'ggplot2',
'cowplot', 'MullerPlot', 'RColorBrewer', 'reshape2', 'lubridate',
'TTR', 'xtable', 'multcomp', 'pander', 'png', 'grid', 'tseries', 'nlme', 'forecast', 'lsmeans')
for (package in package.list) {
if (!require(package, character.only = TRUE, quietly = TRUE)) {
install.packages(package, repos='http://cran.us.r-project.org')
library(package, character.only = TRUE) }
}


```

## 2) LOADING DATA
### Load dataset
In the R code chunk below, do the following:  

1. load the `portal` dataset from in the "*/Week5/data*" folder, and
2. explore the structure of the dataset.

```{r}
portal <- read.table("data/combined.csv", sep = ",", header = TRUE)
str(portal)
print(length(unique(portal$plot_id)))
print(length(unique(portal$species_id)))
print(length(unique(portal$species)))
```

***Question 1***:  Describe some of the attributes of the `portal` dataset.  

a.  How many plots are in `portal`?
b.  How many rodent species are there in the `portal` dataset?

> ***Answer 1a***:24
> ***Answer 1b***:  48

## 3) WRANGLING THE PORTAL DATASET

In the R code chunk below, do the following:  

1. Create a site-by-species matrix for any year of your choosing.
2. Create a vector of plot_type for sites in the site-by-species matrix.
3. Analyze alpha diversity (e.g., Shannon/Simpson) across the sites for that year.
4. Create a PCoA ordination of your site-by-species matrix.
5. Using the hypothesis testing tools you learned in the beta-diversity module, test the hypothesis that species abundances across sites vary as a factor of treatment type (i.e., plot_type). 

```{r}

#'''attach(portal)
#str(portal)
#mysbs94=filter(portal,year==1994)
#str(mysbs94)
#mysbs94=select(mysbs94,plot_id,species_id)'''



portal2 <- unite(portal, col = date, c(year, month, day), sep = "-", remove = FALSE)
portal3 <- unite(portal2, col = species_id, c(genus, species), sep = "_", remove = FALSE)
time.by.species <- group_by(portal, year, plot_id) %>% count(species_id) %>% spread(key = species_id, value = n, fill = 0)


```
```{r}
mysbs82=filter(time.by.species,year==1982)
mysbs82strip<-mysbs82[-c(1,2)]
#dat %>% mutate_each_(funs(factor), l1) %>% mutate_each_(funs(as.numeric), l2)
mysbs82strip<- apply(mysbs82strip,2, as.numeric)
#2
my_type<-portal%>%filter(year==1982)%>%group_by(plot_id,plot_type)%>%count(species_id)%>%spread(key = species_id, value = n, fill = 0)

#3
S.obs <- function(x=""   ){
   rowSums(x>0) *1 
}#for each row x, take the sum of columns for which x > 0


SimpE <- function(x = ""){
S <- S.obs(x)#obsvd richness
x = as.data.frame(x)
D <- diversity(x, "inv")
E <- (D)/S
return(E)
}
thuggy<-SimpE(mysbs82strip)
#apply(mysbs82strip,1,SimpE)
thugy<-apply(mysbs82strip,1,diversity)
#4
package.list <- c('vegan', 'ade4', 'viridis', 'gplots', 'BiodiversityR', 'indicspecies')
for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) {
    install.packages(package)
    library(package, character.only=T)
  }
}
portal82.db <- vegdist(mysbs82strip, method = "bray", upper = TRUE, diag = TRUE)
portal82.pcoa <- cmdscale(portal82.db, eig = TRUE, k = 3)#do the PCoA
str(portal82.pcoa)
explainvar1 <- round(portal82.pcoa$eig[1] / sum(portal82.pcoa$eig), 3) * 100#for each of the first three eigenvalues, assess what proportion of variance it explains
explainvar2 <- round(portal82.pcoa$eig[2] / sum(portal82.pcoa$eig), 3) * 100
explainvar3 <- round(portal82.pcoa$eig[3] / sum(portal82.pcoa$eig), 3) * 100
sum.eig <- sum(explainvar1, explainvar2, explainvar3)#total amt explained in these 3 dimensions

par(mar = c(5, 5, 1, 2) + 0.1)#structure the figure output
# Initiate Plot
plot(portal82.pcoa$points[ ,1], portal82.pcoa$points[ ,2], ylim = c(-0.2, 0.7), xlab = paste("PCoA 1 (", explainvar1, "%)", sep = ""), ylab = paste("PCoA 2 (", explainvar2, "%)", sep = ""), pch = 16, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = FALSE)
# Add Axes
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)
# Add Points & Labels
points(portal82.pcoa$points[ ,1], portal82.pcoa$points[ ,2],
pch = 19, cex = 3, bg = "#bc8d4f", col = "#bc8d4f")
text(portal82.pcoa$points[ ,1], portal82.pcoa$points[ ,2],
labels = row.names(portal82.pcoa$points))
#Now IDfy the most influential spp
portal82REL <- mysbs82strip
  for(i in 1:nrow(mysbs82strip)){
    portal82REL[i, ] = mysbs82strip[i, ] / sum(mysbs82strip[i, ])
    }

portal82.pcoa2 <- add.spec.scores(portal82.pcoa,portal82REL,method = "pcoa.scores")
##################################
#gives error: Error in is.data.frame(x) : 
  #(list) object cannot be coerced to type 'double'
##############################

text(portal82.pcoa2$cproj[ ,1], portal82.pcoa2$cproj[ ,2],labels = row.names(portal82.pcoa2$cproj), col = "#802944")


portal82.ward <- hclust(portal82.db, method = "ward.D2")#now visualize phylogenetically
par(mar = c(1, 5, 2, 2) + 0.1)#set up display settings
plot(portal82.ward, main = "Ward's Clustering",ylab = "Squared Bray-Curtis Distance")#plot the tree

#5
mytrtmnts<-c(my_type$plot_type)
adonis(mysbs82strip ~ mytrtmnts, method = "bray", permutations = 999)
#P=0.786.

```

***Question 2***: Describe how different biodiversity estimates vary among sites.

a. Does diversity vary among sites? Does this correspond to treatment type?
b. Is treatment type a significant predictor of site dissimilarity?

> ***Answer 2a***:

> Among the sites, Shannon's diversity ranges from 1.0364 to 2.1453.

> Sites 16, 23, 7, 10 all cluster together, and all are Rodent Exclosure treatments.

> Sites 19, 15, 3, 21 all cluster together, and all are LT K-ray Exclosures.

> Sites 14, 4, 11, 12, 5 cluster together; and except 5 are controls.

> Sites 6, 18, 1, 2, 13cluster together; 18, 6, and 13 are all Short-Term K-rat exclosures

> Sites 17 and 20 cluster together, but they are not the same treatment.

> Sites 22, 9, 8 cluster together, but only 22 and 8 are the same treatment.

> Site 24, a Rodent Exclosure, is far distant from the other rodent exclosures.

> ***Answer 2b***:

> No, treatment is not a significant predictor of species composition (P = 0.786).

## 4) TIME SERIES ANALYSIS
In the R code chunk below, do the following:  

1. Create a time-by-species matrix that includes year, month, and plot_id for a site other than plot_id 2.
2. Examine per-hectare rodent abundance using simple moving average smoothing.
3. Test whether your data meets the assumption of stationarity.
4. If it does not meet this asumption, explore wasy to make your data stationary.
5. Examine and plot time lags using the partial autocorrelation function (PACF) and autocorrelation function (ACR).
6. Use the tools outlined in the Handout to create an ARMA model.

```{r}

```

***Question 3***: Describe the results from your time series analysis.

a. Does your data meet the assumption of stationarity? If not, what does this violation imply?
b. What does the ACF function do and how does it relate to the ARMA model? How does this differ from the autocorrelation function (ACF)?
c. What results can you conclude from your full ARMA model along with other methods outlined in the time series setcion of the Handout?

> ***Answer 3a***:
> ***Answer 3b***:
> ***Answer 3c***:

## 5) REPEATED MEASURES ANALYSIS OF VARIANCE (RM-ANOVA)
In the R code chunk below, do the following:  

1. Create an appropriate data frame for RM-ANOVA (e.g., yearly species abundance values within plots).
2. Calculate the inverse of Simpson's diversity for each year, and plot it as a function of year for the Control and Rodent Exclosure plots.
3. Perform an RM-ANOVA and construct a F-test using the AR(1), compound symmetery, and unstructured covariance structures.

```{r}


```

***Question 4***: Describe the results from your RM-ANOVA.

a. In your own words describe what a RM-ANOVA test is doing
b. Is there a noticeable trend in the inverse of Simpson's diversity over time?
c. What does the result of your F-test tell you? 
d. Of the three RM-ANOVA models with different covariance structures, which one is best? How does this affect the interpretation of your data?  

> ***Answer 4a***:
> ***Answer 4b***:
> ***Answer 4c***:

## 6) TEMPORAL BETA DIVERSITY

### Turnover
In the R code chunk below, do the following:

1. Calculate species abundances for each taxonomic group (the `taxa` column).
2. Calculate total turnover and turnover due to the gain/loss of species for each group.
3. Visualize turnover within each group

```{r}


```

***Question 5***:

a. How does temporal turnover relate to spatial turnover?
b. Which taxonomic group appears to be the most variable? Which group appears to be the least variable?

### Mean Rank Shift
In the code chunk below, do the following:

1. Choose two plot_types or two plot_ids and compare the mean rank shift (MRS) between them.
2. Plot MRS for each through time. 

```{r}

```

***Question 6***:

a. What does a change in the rank shift tell you about the community?
b. Interpret the analysis and figure you just made.

> ***Answer 6a***:
> ***Answer 6b***:

### Rate Change Interval
In the R code chunk below, do the following:

1. Calculate the rate change interval using the Hellinger distance.
2. Plot the results.

```{r}

```

***Question 7***: 

a. What does it mean to calculate a distance metric across varying time intervals?
b. Interpret the overall results. Develop a hypothesis based on the different responses of each treatment.

> ***Answer 7a***:
> ***Answer 7b***:

## 7) STABILITY
In the R code chunk below, do the following:  

1. Using total abundance as your focal variable, calculate stability (i.e., 1/CV) and synchrony for each plot type.
2. Test for a biodiversity-stability relationship by regressing community stability on mean richness. 
3. Test for a biodiversity-stability relationship by regressing community stability on mean inverse Simpson's diversity.

```{r}


```

***Question 8***:

a. Which plot type has the highest stability in total abundance? How is stability of total abundance measured with the function you learned? How does this measure of stability relate to the coefficient of variation?

b. In your own words, describe the concept of synchrony
c. Interpret the results from the biodiversity-stability relationships you analyzed.

> ***Answer 8a***:
> ***Answer 8b***:
> ***Answer 8c***:

## SYNTHESIS
Compare and contrast the core concepts from temporal and spatial diversity (e.g., autocorrelation, scale, variability, etc.).
Identify a few of the major challenges associated with studying biodiversity through time and across space.  

> ***Answer***:

